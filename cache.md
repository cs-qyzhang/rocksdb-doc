---
title: "Cache"
date: 2020-06-19
lastmod: 2020-06-19
authors: []
---

LevelDB 中的 Cache 默认使用的是 `LRUCache`。`LRUCache`中主要由三个数据结构组成：一个`in_use_`链表保存当前被用户使用的项；一个`lru_`链表以LRU的顺序保存未被用户引用的项；一个`table_`哈希表用于快速索引 Cache 中的项。

Cache 中的项使用`LRUHandle`结构表示，该结构中包含了引用计数`refs`，表示该项被 Cache 以及用户引用的数量。当一个项加入到 Cache 中时引用计数为 1（被 Cache 引用），每有一个用户使用项时计数都会加 1。相反，当项从 Cache 中移除时引用计数减 1，用户不再使用项时计数也减 1。当一个项的引用计数降到 0 时该项将被回收。通过这种方式可以使 Cache 中的项在被 Cache 移除时还可继续保持着被当前用户的引用，直到所有用户都不使用时才会回收。

LevelDB 中的 Cache 使用了分片，具体的 Cache 实现为`ShardedCache`，其中默认将 Cache 分为24个，每个分片都是一个`LRUCache`类。在使用时将键的哈希值的高 4 位作为分片的索引，将键的低位作为分片中哈希表的索引 (这里若将哈希的低4位作为分片索引那么分片与哈希表的功能就一样了，相当于分片实现了哈希表的功能，这样分片就白做了)。分片可以提高查询和插入的速度，减少哈希表的 rehash 以及减少锁的压力，是提高缓存性能的常用方法。
